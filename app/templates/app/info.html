<!-- info.html -->

{% extends 'app/template_base.html' %}

{% load static %}

{% block title %}情報一覧{% endblock %}

{% block contents %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // スクロール位置の復元
        const scrollToElementId = sessionStorage.getItem("scrollToElement");
        if (scrollToElementId) {
            const targetElement = document.getElementById(scrollToElementId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: "smooth", block: "center" });
            }
            sessionStorage.removeItem("scrollToElement");  // 位置情報をクリア
        }

        // 全体情報の作業内容の「編集」ボタンが押されたときの処理
        document.querySelectorAll("button[name='place_remarks_edit']").forEach(button => {
            button.addEventListener("click", function () {
                sessionStorage.setItem("scrollToElement", this.id);  // ボタンのIDを保存
            });
        });

        // 利用者の「編集」ボタンが押されたときの処理
        document.querySelectorAll("button[name='customer_record_edit']").forEach(button => {
            button.addEventListener("click", function () {
                sessionStorage.setItem("scrollToElement", this.id);  // ボタンのIDを保存
            });
        });

        // スタッフの「編集」ボタンが押されたときの処理
        document.querySelectorAll("button[name='staff_record_edit']").forEach(button => {
            button.addEventListener("click", function () {
                sessionStorage.setItem("scrollToElement", this.id);  // ボタンのIDを保存
            });
        });
    });
</script>

<div class="wrapper">

    <form action="{% url 'info_dispatch' work_date=work_date %}" method="post">
        {% csrf_token %}
        <div class="d-flex justify-content-between align-items-end mt-5">
            {% if info %}
            <ul class="nav nav-tabs mt-5" id="tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-info" type="button"
                        role="tab">
                        全体情報
                    </button>
                </li>

                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="transport-tab" data-bs-toggle="tab" data-bs-target="#transport-info"
                        type="button" role="tab">
                        送迎情報
                    </button>
                </li>
            </ul>
            {% else %}
            <div>
                <h2>データが存在しません</h2>
                <button class="btn-sm" id="id_create_data" type="submit" name="create_records" value="0" 
                    {% if not request.user.is_superuser %} disabled {% endif %}>
                    データを作成する
                </button>
            </div>

            {% endif %}
            <div class="d-flex align-items-center gap-2 mb-1">
                {{ calendar_form.date }}
                <button class="btn-sm" type="submit" name="change_date" value="0">更新</button>
            </div>
        </div>
    </form>

    {% if info %}

    <div class="tab-content" id="infoTabContent">
        <!-- 全体情報 -->
        <div class="tab-pane fade show active" id="all-info" role="tabpanel">
            <div class="table-responsive-md">
                <table class="table table-bordered">
                    <thead class="table-header text-center table-primary">
                        <tr>
                            <th style="min-width: 130px;">スタッフ</th>
                            <th style="min-width: 200px;">利用者</th>
                            <th style="min-width: 150px;">作業内容など</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for info in info %}
                        {% if info.staff_cusotmer_list %}
                        <!-- 場所名 -->
                        <tr class="{{info.color}}">
                            <td colspan="3" class="fw-bold">
                                {{ info.place_name }}
                            </td>
                        </tr>
                        {% with info.staff_cusotmer_list|length as rowspan %}
                        {% for staff, customer in info.staff_cusotmer_list %}
                        {% if staff or customer %}
                        <tr>
                            <td>
                                {% if staff %}
                                <div class="d-flex justify-content-between align-items-start">
                                    <!-- 左側：スタッフ情報と現在のステータスボタン -->
                                    <div>
                                        <div class="mt-1">{{ staff.display | linebreaksbr }}</div>
                                        <div class="mt-3">
                                            <button type="button"
                                                class="btn {{ staff.current_status_btn_class }}"
                                                data-bs-toggle="modal" data-bs-target="#statusModal-{{ staff.id }}">
                                                {{ staff.current_status_text }}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- 右側：編集ボタン -->
                                    {% if request.user.is_superuser %}
                                    <form method="post" action="{% url 'info_dispatch' work_date=work_date %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button id="edit-staff_btn-{{ staff.id }}" class="btn-sm text-nowrap"
                                            type="submit" name="staff_record_edit" value="{{ staff.id }}">
                                            編集
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>

                                {% endif %}
                            </td>
                            <td>
                                {% if customer %}
                                <div class="d-flex justify-content-between align-items-start">
                                    <!-- 左側：利用者情報と現在のステータスボタン -->
                                    <div>
                                        <div class="mt-1">{{ customer.display | linebreaksbr }}</div>
                                        <div class="mt-3">
                                            <button type="button"
                                                class="btn mt-2 {{ customer.current_status_btn_class }}"
                                                data-bs-toggle="modal" data-bs-target="#statusModal-{{ customer.id }}">
                                                {{ customer.current_status_text }}
                                            </button>
                                        </div>
                                    </div>

                                    <!-- 右側：編集ボタン -->
                                    {% if request.user.is_superuser %}
                                    <form method="post" action="{% url 'info_dispatch' work_date=work_date %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button id="edit-customer_btn-{{ customer.id }}" class="btn-sm text-nowrap"
                                            type="submit" name="customer_record_edit" value="{{ customer.id }}">
                                            編集
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                            {% if forloop.first %}
                            <td rowspan="{{ rowspan }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    {{ info.remarks | linebreaksbr }}
                                    {% if info.place_id > 0 %}
                                    <form action="{% url 'info_dispatch' work_date=work_date %}" method="post">
                                        {% csrf_token %}
                                        <button id="edit_place_remarks_btn-{{ info.place_id }}" class="btn-sm text-nowrap"
                                            type="submit" name="place_remarks_edit" value="{{ info.place_id }}">
                                            編集
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                            {% endif %}

                        </tr>
                        {% endif %}
                        {% endfor %}
                        {% endwith %}
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 送迎情報 -->
        <div class="tab-pane fade" id="transport-info" role="tabpanel">
            <div class="table-responsive-md">
                <table class="table table-bordered">
                    <thead class="table-header text-center table-primary">
                        <tr>
                            <th style="min-width: 130px;">スタッフ名</th>
                            <th style="min-width: 150px;">朝の送迎</th>
                            <th style="min-width: 150px;">帰りの送迎</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for row in transport_table_rows %}
                        <tr>
                            <td>{{ row.staff.name }}</td>
                            <td>{{ row.morning_text|safe }}</td>
                            <td>{{ row.return_text|safe }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>

        </div>
    </div>

    {% for info in info %}
    {% for staff, customer in info.staff_cusotmer_list %}
    {% if staff %}
    {% include "app/partials/current_status_modal.html" with member=staff current_status_choices=current_status_staff_choices%}
    {% endif %}
    {% if customer %}
    {% include "app/partials/current_status_modal.html" with member=customer current_status_choices=current_status_customer_choices%}
    {% endif %}
    {% endfor %}
    {% endfor %}

    {% endif %}

</div>

{% endblock %}